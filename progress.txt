# Ralph Progress Log
Started: January 9, 2025
Feature: Enhanced Financial Export with 3-Statement Model and AI Insights

## Codebase Patterns

### Google Sheets Export
- Main export logic in `/src/lib/google-sheets.ts` (668 lines)
- Uses Google Sheets API v4 batchUpdate for efficiency
- Token refresh handled automatically before API calls
- Professional formatting: dark slate blue headers (#2F3D4C), light gray sections

### Transaction Classification
- `/src/lib/transaction-classifier.ts` handles internal transfers and CC payment detection
- Matches opposite transactions across accounts for transfer detection
- Uses Plaid transaction codes for CC payment identification

### Financial Data Structures
- Types defined in `/src/types/index.ts`
- MonthlyFinancials, FinancialStatement, ClassifiedTransaction interfaces
- Plaid categories mapped to app categories in transactions route

### API Patterns
- Next.js App Router API routes in `/src/app/api/`
- Supabase for auth and data persistence
- Service role client used for elevated permissions when needed

### Existing Export Flow
1. User clicks Export in ExportDialog component
2. POST to /api/export/sheets with date range
3. Fetches transactions from Plaid
4. Classifies transactions
5. Builds financial statement data structure
6. Creates Google Sheet with formatting
7. Returns spreadsheet URL

### Testing Approach
- Run `npm run typecheck` for type validation
- Use Claude-in-Chrome browser tools for visual verification
- Google Drive MCP available for reading/writing sheet values

### Financial Analyst Color Standards (CRITICAL)
Per industry standards (Wall Street Prep, Macabacus, CFI):
- **Blue text** (RGB: 0,0,255): Hard-coded inputs, historical data
- **Black text** (RGB: 0,0,0): Formulas referencing same sheet
- **Green text** (RGB: 0,128,0): Cross-sheet references
- **Red text** (RGB: 255,0,0): Errors, warnings, external links

Use FINANCIAL_COLORS constants in google-sheets.ts for consistent application.

### MCP Session Tips
- `/context` - Check context window usage during long sessions
- `/mcp list` - Verify Google Drive MCP is connected
- After writing to sheets, verify with `sheets_read_range` or browser screenshot

### Cross-Sheet Formulas in Google Sheets
- Use `='SheetName'!ColumnRow` format (e.g., `='Summary'!F7`)
- To dynamically find rows, build the data array and search for labels
- Use `getColumnLetter(index)` to convert 0-based index to column letter (0=A, 1=B, etc.)
- Formula text must be written as strings to the data array - Google Sheets interprets `=` as formula

### Reconciliation Requirements (CRITICAL)
The spreadsheet must include internal checks that tie to bank reality:

1. **Account Balance Proof** (in Balance Sheet or Dashboard)
   - Show current Plaid balance for each account
   - Compare against calculated values
   - Flag any discrepancy

2. **Transaction Count Check**
   - Total transactions in Transactions sheet
   - Breakdown by classification (should sum to total)

3. **Cash Flow Proof Formula**
   - Beginning Cash + Net Income - CC Payments = Ending Cash
   - Ending Cash should match current depository balances from Plaid

This ensures the user knows they're working with complete, accurate data.

### Testing Framework
- Vitest configured in `vitest.config.ts`
- Tests in `/src/lib/__tests__/` directory
- Run tests: `npm test`
- Run in watch mode: `npm test:watch`
- Path alias `@/` configured for imports

---

## 2025-01-09 23:23 - US-001
- What was implemented:
  - Created `/src/lib/financial-metrics.ts` with `calculateCoreMetrics()` function
  - Added `FinancialMetrics` interface to `/src/types/index.ts`
  - Installed Vitest and configured testing framework
  - Created 9 unit tests covering all acceptance criteria

- Files changed:
  - `package.json` - Added test scripts and vitest dependency
  - `package-lock.json` - Updated dependencies
  - `vitest.config.ts` - New Vitest configuration with path aliases
  - `src/types/index.ts` - Added FinancialMetrics interface
  - `src/lib/financial-metrics.ts` - New calculateCoreMetrics function
  - `src/lib/__tests__/financial-metrics.test.ts` - 9 unit tests

- **Learnings for future iterations:**
  - The existing transaction classifier checks for negative amounts (income) BEFORE checking for internal transfers. This means incoming transfer legs are classified as income, not as internal_transfer.
  - Only OUTGOING transfers (positive amounts) and OUTGOING CC payments (positive amounts from depository accounts) are properly excluded by the classifier.
  - Vitest works well with Next.js - just configure path aliases in vitest.config.ts to match tsconfig.
  - Use `Math.abs()` for Plaid amounts - income is negative (money coming in), expenses are positive (money going out).

---

## 2025-01-09 23:28 - US-002
- What was implemented:
  - Added `TrendMetrics`, `TrendDirection`, and `MonthlyCashFlow` interfaces to `/src/types/index.ts`
  - Added `calculateTrendMetrics()` function to `/src/lib/financial-metrics.ts`
  - Function calculates month-over-month change in net cash flow
  - Function calculates 3-month moving average
  - Returns trend direction: 'improving' | 'stable' | 'declining' based on 5% threshold
  - Returns percentage change from prior period
  - Created 10 new unit tests for trend metrics (total 19 tests passing)

- Files changed:
  - `src/types/index.ts` - Added TrendMetrics, TrendDirection, MonthlyCashFlow interfaces
  - `src/lib/financial-metrics.ts` - Added calculateTrendMetrics() and helper functions
  - `src/lib/__tests__/financial-metrics.test.ts` - Added 10 new test cases for trend metrics

- **Learnings for future iterations:**
  - Internal transfer detection requires a MATCHING PAIR of transactions with opposite signs (one positive leaving account A, one negative arriving in account B) within a 3-day window
  - Single-sided transfers (only the OUT or only the IN) won't be classified as internal_transfer
  - The 5% stability threshold is reasonable for MoM trend detection - smaller changes are "stable"
  - Edge case: When prior month net cash flow is zero, use 100/-100 as percentage change indicator

---

## 2025-01-09 23:32 - US-003
- What was implemented:
  - Added `CategoryBreakdownItem` and `CategoryBreakdownResult` interfaces to `/src/types/index.ts`
  - Added `calculateCategoryBreakdown()` function to `/src/lib/financial-metrics.ts`
  - Added helper function `calculateMonthlySpendByCategory()` for MoM calculations
  - Function ranks categories by total spend descending
  - Calculates % of total expenses and % of income for each category
  - Returns top 5 categories plus all categories with rankings
  - Computes month-over-month change per category
  - Created 13 new unit tests for category breakdown (total 32 tests passing)

- Files changed:
  - `src/types/index.ts` - Added CategoryBreakdownItem, CategoryBreakdownResult interfaces
  - `src/lib/financial-metrics.ts` - Added calculateCategoryBreakdown() and calculateMonthlySpendByCategory() functions
  - `src/lib/__tests__/financial-metrics.test.ts` - Added 13 new test cases for category breakdown

- **Learnings for future iterations:**
  - When testing internal transfer exclusion, must include BOTH legs of the transfer (OUT and matching IN) to trigger the `internal_transfer` classification
  - Single month of data should return MoM change = 0 (no prior month to compare to), need explicit `hasPriorMonth` flag
  - Category breakdown only includes expenses (positive Plaid amounts), excludes income (negative amounts)
  - The `getCashFlowTransactions()` helper already filters out internal_transfer, credit_card_payment, and excluded classifications

---

## 2025-01-09 23:35 - US-004
- What was implemented:
  - Added `BalanceSheet`, `BalanceSheetAccount`, and `BalanceSheetAccountGroup` interfaces to `/src/types/index.ts`
  - Added `calculateBalanceSheet()` function to `/src/lib/financial-metrics.ts`
  - Function groups accounts by type (depository = Liquid Assets, credit = Credit Card Debt)
  - Calculates totalAssets, totalLiabilities, and netWorth
  - Handles null balances gracefully (treats as 0)
  - Includes ISO date string for point-in-time snapshot reference
  - Created 12 new unit tests for balance sheet (total 44 tests passing)

- Files changed:
  - `src/types/index.ts` - Added BalanceSheet, BalanceSheetAccount, BalanceSheetAccountGroup interfaces
  - `src/lib/financial-metrics.ts` - Added calculateBalanceSheet() function
  - `src/lib/__tests__/financial-metrics.test.ts` - Added 12 new test cases for balance sheet

- **Learnings for future iterations:**
  - Balance sheet function doesn't need transactions - only accounts with current balances
  - Plaid credit card balances are positive numbers representing amount owed
  - Investment and loan accounts are not currently included - could be added in future enhancements
  - The asOfDate is generated at calculation time using `new Date().toISOString()`

---

## 2025-01-09 23:39 - US-005
- What was implemented:
  - Added Dashboard as first sheet (index 0) in Google Sheets export
  - Created `buildDashboardData()` function returning data + layout metadata
  - Created `buildDashboardFormattingRequests()` for professional styling
  - Added `FINANCIAL_COLORS` constants for industry-standard analyst color coding (blue=input, black=formula, green=cross-ref, red=error)
  - Dashboard contains 4 sections: THE BIG PICTURE, KEY RATIOS, WHERE YOUR MONEY GOES, INSIGHTS
  - Each section has proper header styling (dark slate #2F3D4C background, white text)
  - Placeholder cells with "$0.00" and "0%" for future formula-driven values
  - Note row at bottom about available named ranges for user extensibility
  - Frozen title row and first column for navigation
  - Updated `createFinancialSpreadsheet()` to include Dashboard and shift other sheet indices

- Files changed:
  - `src/lib/google-sheets.ts` - Added FINANCIAL_COLORS, DashboardLayout interface, buildDashboardData(), buildDashboardFormattingRequests(), updated createFinancialSpreadsheet() (+416 lines)

- **Learnings for future iterations:**
  - The DashboardLayout interface tracks row indices for each section, making it easy to apply targeted formatting
  - Section headers should be merged cells for clean appearance (mergeCells with MERGE_ALL)
  - Use updateDimensionProperties with pixelSize for fixed column widths (more predictable than autoResize)
  - Placeholder values like "$0.00" are literal strings now - US-006 will replace them with formulas
  - The spreadsheet title was updated from "Financial Statement" to "Financial Dashboard" to reflect the new focus
  - Google Sheets API batchUpdate processes requests in order, so Dashboard formatting runs first

---

## 2025-01-09 23:43 - US-006
- What was implemented:
  - Added formula-driven values to Big Picture section referencing Summary sheet
  - Total Income, Total Expenses, Net Cash Flow now use `='Summary'!{col}{row}` formulas
  - Added `findSummaryRowIndices()` to dynamically locate metric rows in Summary sheet
  - Added `getColumnLetter()` helper to convert column index to letter (A, B, C, etc.)
  - Added `buildTrendText()` for income/expense MoM trend indicators
  - Added `buildCashFlowTrendText()` for net cash flow trend with direction
  - Trend text shows arrows (↑↓→), percentage change, and direction (Improving/Declining/Stable)
  - Applied currency formatting ($#,##0.00) to Period Total and Monthly Average columns
  - Applied green text color to formula cells (cross-sheet reference standard)
  - Added conditional formatting for Net Cash Flow row:
    - Positive: Green background + green bold text
    - Negative: Red background + red bold text

- Files changed:
  - `src/lib/google-sheets.ts` - Added helper functions and updated buildDashboardData() and buildDashboardFormattingRequests() (+280 lines)

- **Learnings for future iterations:**
  - Summary sheet row positions must be calculated by building the data and searching for row labels
  - Column letters for formulas: `getColumnLetter(index)` where index is 0-based (0=A, 1=B, etc.)
  - Google Sheets formula format: `='SheetName'!ColumnRow` (e.g., `='Summary'!F7`)
  - Conditional formatting with `NUMBER_GREATER` and `NUMBER_LESS` types work with formula-derived values
  - MonthlyFinancials type contains `income.total` and `expenses.total` for trend calculations
  - For MoM percentage change when prior period is zero: use 100/-100 as indicator, not infinity

---

## 2025-01-09 23:47 - US-007
- What was implemented:
  - Extended `findSummaryRowIndices()` to locate SUBTOTAL rows for Essential and Discretionary expense sections
  - Added formula-driven Key Ratios section with 5 columns: Ratio, Your Value, Target, Progress, Status
  - Savings Rate formula references Summary sheet savings rate directly
  - Essential/Discretionary Expenses formulas calculate % of income from respective SUBTOTAL rows
  - REPT() progress bars create visual 10-block gauges (█ for filled, ░ for empty)
  - Status column uses IF formulas to display emoji indicators (✓ On Track, ⚠ Close, ⚡ Needs Attention)
  - Target thresholds: Savings ≥20%, Essential ≤50%, Discretionary ≤30%
  - 3-tier conditional formatting for each ratio:
    - Green background when meeting/exceeding target
    - Yellow background when close to target
    - Red background when concerning
  - Percentage format applied to "Your Value" column with green text (cross-sheet ref standard)
  - Progress bar column uses monospace font (Roboto Mono) for consistent display

- Files changed:
  - `src/lib/google-sheets.ts` - Extended findSummaryRowIndices(), updated buildDashboardData() and buildDashboardFormattingRequests() (+472 lines)

- **Learnings for future iterations:**
  - To find SUBTOTAL rows in different sections, track which section you're in with boolean flags as you iterate
  - REPT("█", count) creates Unicode block characters - use monospace font for consistent spacing
  - For 3-tier conditional formatting, order matters: add rules in order of specificity (most specific first)
  - Google Sheets conditional formatting supports CUSTOM_FORMULA for AND/OR conditions
  - When expanding column count in Dashboard, update all row arrays to have consistent length
  - The layout object tracks row indices which are 0-indexed; formulas need 1-indexed row references

---

## 2025-01-10 00:00 - US-008
- What was implemented:
  - Added `findTopSpendingCategories()` function to get top 7 spending categories sorted by total descending
  - Replaced placeholder spending rows with formula-driven category data
  - Monthly Average formula references Detailed Categories sheet
  - Percentage of expenses formula calculates category total / total expenses from Summary sheet
  - REPT() visual bars show proportional spending with 10-block gauge (█ filled, ░ empty)
  - Empty placeholder rows ("—") shown if fewer than 7 categories have spending
  - Added formatting rules for spending breakdown section:
    - Currency format for Monthly Avg column
    - Percentage format for % of Expenses column
    - Monospace font (Roboto Mono) for visual bars
    - Green text for cross-sheet reference cells
    - Blue-ish color for visual bars (aesthetic choice)

- Files changed:
  - `src/lib/google-sheets.ts` - Added findTopSpendingCategories(), updated buildDashboardData() and buildDashboardFormattingRequests() (+175 lines)

- **Learnings for future iterations:**
  - Detailed Categories sheet structure: Category (col A), [months...], Total, Avg
  - To reference Detailed Categories sheet in formulas: `='Detailed Categories'!ColRow`
  - The spendingEndRow is now dynamically calculated (`data.length - 1`) since we build rows in a loop
  - Filter categories with `total > 0` to avoid showing categories with no spending
  - Use `findIndex()` on the built data array to locate category rows in the sheet
  - The formula `MAX(1, MIN(10, ROUND(pct*10)))` ensures at least 1 block but caps at 10 for visual balance

---

## 2025-01-10 00:15 - US-009
- What was implemented:
  - Created 'Income Statement' sheet as the second sheet (after Dashboard) with proper P&L structure
  - Added `IncomeStatementLayout` interface to track row indices for formatting
  - Added `buildIncomeStatementData()` function building the Income Statement data structure
  - Added `buildIncomeStatementFormattingRequests()` function for professional styling
  - INCOME section with Salary/Wages, Investment Income, Other Income subcategories
  - ESSENTIAL EXPENSES section with 7 categories (Housing, Utilities, Transportation, Groceries, Insurance, Medical, Debt Service)
  - DISCRETIONARY EXPENSES section with 6 categories (Dining Out, Entertainment, Shopping, Travel, Subscriptions, Other)
  - Formula-driven totals: TOTAL INCOME, SUBTOTAL Essential, SUBTOTAL Discretionary, TOTAL EXPENSES, NET INCOME
  - Financial analyst color coding per CLAUDE.md standards:
    - Blue text for hard-coded inputs (monthly transaction data values)
    - Black text for same-sheet formulas (SUMs, calculations)
  - Conditional formatting for NET INCOME row (green when positive, red when negative)
  - Updated `createFinancialSpreadsheet()` to include Income Statement as second sheet (index 1)

- Files changed:
  - `src/lib/google-sheets.ts` - Added IncomeStatementLayout interface, buildIncomeStatementData(), buildIncomeStatementFormattingRequests(), updated createFinancialSpreadsheet() (+597 lines)

- **Learnings for future iterations:**
  - Income Statement is positioned as index 1 (after Dashboard at 0), shifting Summary to index 2
  - Sheet names with spaces need single quotes in range references: `'Income Statement'!A1`
  - Formula row references are 1-indexed in Google Sheets, while layout row indices are 0-indexed
  - For SUM formulas spanning data rows, calculate start/end rows dynamically based on data.length
  - The Total and Avg columns use formulas that reference the Total row, not individual cells
  - FINANCIAL_COLORS.inputBlue applies to monthly data columns only (not Total/Avg which are formula-derived)
  - Subtotal/Total rows keep the default black text since they contain same-sheet formulas

---

## 2025-01-10 00:25 - US-010
- What was implemented:
  - Created 'Balance Sheet' sheet as the third sheet (after Dashboard and Income Statement)
  - Added `BalanceSheetLayout` interface to track row indices for formatting
  - Added `buildBalanceSheetData()` function creating Balance Sheet structure:
    - ASSETS section with Liquid Assets subheading (lists all depository accounts)
    - LIABILITIES section with Credit Card Debt subheading (lists all credit accounts)
    - NET WORTH calculation as formula (=Total Assets - Total Liabilities)
    - Point-in-time snapshot with formatted "As of: [date]" display
  - Added `buildBalanceSheetFormattingRequests()` function for professional styling:
    - Blue text for account balances (hard-coded inputs from Plaid)
    - Black text for formula cells (SUM totals, NET WORTH calculation)
    - Conditional formatting for NET WORTH (green bg when positive, red bg when negative)
    - Currency formatting for all balance columns
    - Dark headers, section headers with light gray background
    - Professional borders with thicker section dividers
  - Updated `createFinancialSpreadsheet()` signature to accept optional `accounts` parameter
  - Updated export API route to pass `allAccounts` to create the Balance Sheet
  - Handles empty account states gracefully with placeholder text

- Files changed:
  - `src/lib/google-sheets.ts` - Added BalanceSheetLayout interface, buildBalanceSheetData(), buildBalanceSheetFormattingRequests(), updated imports and createFinancialSpreadsheet() (+580 lines)
  - `src/app/api/export/sheets/route.ts` - Pass accounts to createFinancialSpreadsheet()

- **Learnings for future iterations:**
  - Balance Sheet is positioned at index 2 (Dashboard=0, Income Statement=1, Balance Sheet=2)
  - Sheet indices shift when adding new sheets - Summary becomes index 3, Detailed Categories becomes index 4, Transactions becomes index 5
  - The `calculateBalanceSheet()` function from financial-metrics.ts handles the grouping logic - just import and use it
  - For dynamic row layouts, track the current row with `data.length` as you build the array
  - Formulas referencing dynamic row positions: use 1-indexed (e.g., `=B${dataRow + 1}`) since layout indices are 0-indexed
  - Empty account states should show placeholder text (e.g., "No depository accounts connected") with balance 0
  - The accounts parameter is optional in the function signature to maintain backward compatibility

---

## 2025-01-10 00:40 - US-011
- What was implemented:
  - Created 'Cash Flow' sheet as the fourth sheet (after Balance Sheet, before Summary)
  - Added `CashFlowLayout` interface to track row indices for formatting
  - Added `buildCashFlowData()` function creating Cash Flow Statement structure:
    - OPERATING ACTIVITIES section with Net Income from P&L (cross-sheet reference)
    - NET INCOME FROM OPERATIONS total row
    - FINANCING ACTIVITIES section with CC payments and internal transfers (info only)
    - NET FINANCING ACTIVITIES total row
    - NET CHANGE IN CASH calculation (Operating + Financing)
    - Beginning Cash Balance row with running balance tracking
    - Ending Cash Balance row with formula
    - Note about excluding internal transfers
  - Added `buildCashFlowFormattingRequests()` function for professional styling:
    - Green text for cross-sheet references (Net Income from Income Statement)
    - Blue text for Beginning Cash Balance (hard-coded input)
    - Black text for same-sheet formulas
    - Conditional formatting for NET CHANGE IN CASH (green when positive, red when negative)
    - Dark headers, section headers with light gray background
    - Professional borders with thicker section dividers
  - Updated `createFinancialSpreadsheet()` to include Cash Flow sheet:
    - Cash Flow added at index 3 (Dashboard=0, Income Statement=1, Balance Sheet=2, Cash Flow=3)
    - Summary shifted to index 4, Detailed Categories to index 5, Transactions to index 6
    - Uses beginning cash balance from total liquid assets (Balance Sheet data)

- Files changed:
  - `src/lib/google-sheets.ts` - Added CashFlowLayout interface, buildCashFlowData(), buildCashFlowFormattingRequests(), updated createFinancialSpreadsheet() (+612 lines)

- **Learnings for future iterations:**
  - Cash Flow sheet position is index 3, shifting Summary and Detailed Categories sheets
  - To reference another sheet's dynamic row, first call that sheet's build function to get the layout, then use `layout.rowName + 1` for 1-indexed reference
  - The `MonthlyFinancials.transfers` object contains `creditCardPayments` and `internal` transfer amounts
  - CC payments are shown as negative values (cash outflow) in financing section
  - Internal transfers are shown for informational purposes but excluded from net financing calculation
  - Beginning cash balance uses the current total liquid assets from Balance Sheet - this is a simplification (ideally would reconstruct from transaction history)
  - Running balance calculation: Beginning[n+1] = Ending[n] where Ending = Beginning + Net Change

---
