# Ralph Progress Log
Started: January 9, 2025
Feature: Enhanced Financial Export with 3-Statement Model and AI Insights

## Codebase Patterns

### Google Sheets Export
- Main export logic in `/src/lib/google-sheets.ts` (668 lines)
- Uses Google Sheets API v4 batchUpdate for efficiency
- Token refresh handled automatically before API calls
- Professional formatting: dark slate blue headers (#2F3D4C), light gray sections

### Transaction Classification
- `/src/lib/transaction-classifier.ts` handles internal transfers and CC payment detection
- Matches opposite transactions across accounts for transfer detection
- Uses Plaid transaction codes for CC payment identification

### Financial Data Structures
- Types defined in `/src/types/index.ts`
- MonthlyFinancials, FinancialStatement, ClassifiedTransaction interfaces
- Plaid categories mapped to app categories in transactions route

### API Patterns
- Next.js App Router API routes in `/src/app/api/`
- Supabase for auth and data persistence
- Service role client used for elevated permissions when needed

### Existing Export Flow
1. User clicks Export in ExportDialog component
2. POST to /api/export/sheets with date range
3. Fetches transactions from Plaid
4. Classifies transactions
5. Builds financial statement data structure
6. Creates Google Sheet with formatting
7. Returns spreadsheet URL

### Testing Approach
- Run `npm run typecheck` for type validation
- Use Claude-in-Chrome browser tools for visual verification
- Google Drive MCP available for reading/writing sheet values

### Financial Analyst Color Standards (CRITICAL)
Per industry standards (Wall Street Prep, Macabacus, CFI):
- **Blue text** (RGB: 0,0,255): Hard-coded inputs, historical data
- **Black text** (RGB: 0,0,0): Formulas referencing same sheet
- **Green text** (RGB: 0,128,0): Cross-sheet references
- **Red text** (RGB: 255,0,0): Errors, warnings, external links

Use FINANCIAL_COLORS constants in google-sheets.ts for consistent application.

### MCP Session Tips
- `/context` - Check context window usage during long sessions
- `/mcp list` - Verify Google Drive MCP is connected
- After writing to sheets, verify with `sheets_read_range` or browser screenshot

### Cross-Sheet Formulas in Google Sheets
- Use `='SheetName'!ColumnRow` format (e.g., `='Summary'!F7`)
- To dynamically find rows, build the data array and search for labels
- Use `getColumnLetter(index)` to convert 0-based index to column letter (0=A, 1=B, etc.)
- Formula text must be written as strings to the data array - Google Sheets interprets `=` as formula

### Reconciliation Requirements (CRITICAL)
The spreadsheet must include internal checks that tie to bank reality:

1. **Account Balance Proof** (in Balance Sheet or Dashboard)
   - Show current Plaid balance for each account
   - Compare against calculated values
   - Flag any discrepancy

2. **Transaction Count Check**
   - Total transactions in Transactions sheet
   - Breakdown by classification (should sum to total)

3. **Cash Flow Proof Formula**
   - Beginning Cash + Net Income - CC Payments = Ending Cash
   - Ending Cash should match current depository balances from Plaid

This ensures the user knows they're working with complete, accurate data.

### Testing Framework
- Vitest configured in `vitest.config.ts`
- Tests in `/src/lib/__tests__/` directory
- Run tests: `npm test`
- Run in watch mode: `npm test:watch`
- Path alias `@/` configured for imports

---

## 2025-01-09 23:23 - US-001
- What was implemented:
  - Created `/src/lib/financial-metrics.ts` with `calculateCoreMetrics()` function
  - Added `FinancialMetrics` interface to `/src/types/index.ts`
  - Installed Vitest and configured testing framework
  - Created 9 unit tests covering all acceptance criteria

- Files changed:
  - `package.json` - Added test scripts and vitest dependency
  - `package-lock.json` - Updated dependencies
  - `vitest.config.ts` - New Vitest configuration with path aliases
  - `src/types/index.ts` - Added FinancialMetrics interface
  - `src/lib/financial-metrics.ts` - New calculateCoreMetrics function
  - `src/lib/__tests__/financial-metrics.test.ts` - 9 unit tests

- **Learnings for future iterations:**
  - The existing transaction classifier checks for negative amounts (income) BEFORE checking for internal transfers. This means incoming transfer legs are classified as income, not as internal_transfer.
  - Only OUTGOING transfers (positive amounts) and OUTGOING CC payments (positive amounts from depository accounts) are properly excluded by the classifier.
  - Vitest works well with Next.js - just configure path aliases in vitest.config.ts to match tsconfig.
  - Use `Math.abs()` for Plaid amounts - income is negative (money coming in), expenses are positive (money going out).

---

## 2025-01-09 23:28 - US-002
- What was implemented:
  - Added `TrendMetrics`, `TrendDirection`, and `MonthlyCashFlow` interfaces to `/src/types/index.ts`
  - Added `calculateTrendMetrics()` function to `/src/lib/financial-metrics.ts`
  - Function calculates month-over-month change in net cash flow
  - Function calculates 3-month moving average
  - Returns trend direction: 'improving' | 'stable' | 'declining' based on 5% threshold
  - Returns percentage change from prior period
  - Created 10 new unit tests for trend metrics (total 19 tests passing)

- Files changed:
  - `src/types/index.ts` - Added TrendMetrics, TrendDirection, MonthlyCashFlow interfaces
  - `src/lib/financial-metrics.ts` - Added calculateTrendMetrics() and helper functions
  - `src/lib/__tests__/financial-metrics.test.ts` - Added 10 new test cases for trend metrics

- **Learnings for future iterations:**
  - Internal transfer detection requires a MATCHING PAIR of transactions with opposite signs (one positive leaving account A, one negative arriving in account B) within a 3-day window
  - Single-sided transfers (only the OUT or only the IN) won't be classified as internal_transfer
  - The 5% stability threshold is reasonable for MoM trend detection - smaller changes are "stable"
  - Edge case: When prior month net cash flow is zero, use 100/-100 as percentage change indicator

---

## 2025-01-09 23:32 - US-003
- What was implemented:
  - Added `CategoryBreakdownItem` and `CategoryBreakdownResult` interfaces to `/src/types/index.ts`
  - Added `calculateCategoryBreakdown()` function to `/src/lib/financial-metrics.ts`
  - Added helper function `calculateMonthlySpendByCategory()` for MoM calculations
  - Function ranks categories by total spend descending
  - Calculates % of total expenses and % of income for each category
  - Returns top 5 categories plus all categories with rankings
  - Computes month-over-month change per category
  - Created 13 new unit tests for category breakdown (total 32 tests passing)

- Files changed:
  - `src/types/index.ts` - Added CategoryBreakdownItem, CategoryBreakdownResult interfaces
  - `src/lib/financial-metrics.ts` - Added calculateCategoryBreakdown() and calculateMonthlySpendByCategory() functions
  - `src/lib/__tests__/financial-metrics.test.ts` - Added 13 new test cases for category breakdown

- **Learnings for future iterations:**
  - When testing internal transfer exclusion, must include BOTH legs of the transfer (OUT and matching IN) to trigger the `internal_transfer` classification
  - Single month of data should return MoM change = 0 (no prior month to compare to), need explicit `hasPriorMonth` flag
  - Category breakdown only includes expenses (positive Plaid amounts), excludes income (negative amounts)
  - The `getCashFlowTransactions()` helper already filters out internal_transfer, credit_card_payment, and excluded classifications

---

## 2025-01-09 23:35 - US-004
- What was implemented:
  - Added `BalanceSheet`, `BalanceSheetAccount`, and `BalanceSheetAccountGroup` interfaces to `/src/types/index.ts`
  - Added `calculateBalanceSheet()` function to `/src/lib/financial-metrics.ts`
  - Function groups accounts by type (depository = Liquid Assets, credit = Credit Card Debt)
  - Calculates totalAssets, totalLiabilities, and netWorth
  - Handles null balances gracefully (treats as 0)
  - Includes ISO date string for point-in-time snapshot reference
  - Created 12 new unit tests for balance sheet (total 44 tests passing)

- Files changed:
  - `src/types/index.ts` - Added BalanceSheet, BalanceSheetAccount, BalanceSheetAccountGroup interfaces
  - `src/lib/financial-metrics.ts` - Added calculateBalanceSheet() function
  - `src/lib/__tests__/financial-metrics.test.ts` - Added 12 new test cases for balance sheet

- **Learnings for future iterations:**
  - Balance sheet function doesn't need transactions - only accounts with current balances
  - Plaid credit card balances are positive numbers representing amount owed
  - Investment and loan accounts are not currently included - could be added in future enhancements
  - The asOfDate is generated at calculation time using `new Date().toISOString()`

---

## 2025-01-09 23:39 - US-005
- What was implemented:
  - Added Dashboard as first sheet (index 0) in Google Sheets export
  - Created `buildDashboardData()` function returning data + layout metadata
  - Created `buildDashboardFormattingRequests()` for professional styling
  - Added `FINANCIAL_COLORS` constants for industry-standard analyst color coding (blue=input, black=formula, green=cross-ref, red=error)
  - Dashboard contains 4 sections: THE BIG PICTURE, KEY RATIOS, WHERE YOUR MONEY GOES, INSIGHTS
  - Each section has proper header styling (dark slate #2F3D4C background, white text)
  - Placeholder cells with "$0.00" and "0%" for future formula-driven values
  - Note row at bottom about available named ranges for user extensibility
  - Frozen title row and first column for navigation
  - Updated `createFinancialSpreadsheet()` to include Dashboard and shift other sheet indices

- Files changed:
  - `src/lib/google-sheets.ts` - Added FINANCIAL_COLORS, DashboardLayout interface, buildDashboardData(), buildDashboardFormattingRequests(), updated createFinancialSpreadsheet() (+416 lines)

- **Learnings for future iterations:**
  - The DashboardLayout interface tracks row indices for each section, making it easy to apply targeted formatting
  - Section headers should be merged cells for clean appearance (mergeCells with MERGE_ALL)
  - Use updateDimensionProperties with pixelSize for fixed column widths (more predictable than autoResize)
  - Placeholder values like "$0.00" are literal strings now - US-006 will replace them with formulas
  - The spreadsheet title was updated from "Financial Statement" to "Financial Dashboard" to reflect the new focus
  - Google Sheets API batchUpdate processes requests in order, so Dashboard formatting runs first

---

## 2025-01-09 23:43 - US-006
- What was implemented:
  - Added formula-driven values to Big Picture section referencing Summary sheet
  - Total Income, Total Expenses, Net Cash Flow now use `='Summary'!{col}{row}` formulas
  - Added `findSummaryRowIndices()` to dynamically locate metric rows in Summary sheet
  - Added `getColumnLetter()` helper to convert column index to letter (A, B, C, etc.)
  - Added `buildTrendText()` for income/expense MoM trend indicators
  - Added `buildCashFlowTrendText()` for net cash flow trend with direction
  - Trend text shows arrows (↑↓→), percentage change, and direction (Improving/Declining/Stable)
  - Applied currency formatting ($#,##0.00) to Period Total and Monthly Average columns
  - Applied green text color to formula cells (cross-sheet reference standard)
  - Added conditional formatting for Net Cash Flow row:
    - Positive: Green background + green bold text
    - Negative: Red background + red bold text

- Files changed:
  - `src/lib/google-sheets.ts` - Added helper functions and updated buildDashboardData() and buildDashboardFormattingRequests() (+280 lines)

- **Learnings for future iterations:**
  - Summary sheet row positions must be calculated by building the data and searching for row labels
  - Column letters for formulas: `getColumnLetter(index)` where index is 0-based (0=A, 1=B, etc.)
  - Google Sheets formula format: `='SheetName'!ColumnRow` (e.g., `='Summary'!F7`)
  - Conditional formatting with `NUMBER_GREATER` and `NUMBER_LESS` types work with formula-derived values
  - MonthlyFinancials type contains `income.total` and `expenses.total` for trend calculations
  - For MoM percentage change when prior period is zero: use 100/-100 as indicator, not infinity

---
